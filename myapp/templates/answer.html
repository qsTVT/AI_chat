{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AI 聊天助手</title>
    <script src="{% static 'js/vue.min.js' %}"></script>
    <script src="{% static 'js/index.js' %}"></script>
    <script src="{% static 'js/marked.min.js' %}"></script>
    <script src="{% static 'js/purify.min.js' %}"></script>
    <script src="{% static 'js/axios.min.js' %}"></script>
    <link href="{% static 'css/index.css' %}" rel="stylesheet"/>
    <link href="{% static 'css/element-icons.css' %}" rel="stylesheet">
</head>
<body>
{% verbatim %}
<div id="chatApp">
    <div id="chat-layout">
        <div id="history-panel">
            <div class="history-header">
                <div class="history-title">
                    <span>对话列表</span>
                    <el-button type="text" icon="el-icon-plus" style="color: #fff; float: right;" @click="createNewSession">新建</el-button>
                </div>
            </div>
            <div class="history-list">
                <div v-for="session in sessionList"
                     :key="session.id"
                     class="history-item"
                     :class="{ active: currentSessionId === session.id }"
                     @click="switchSession(session.id)">
                     
                    <div class="history-item-content" v-if="editingSessionId !== session.id">
                        <div class="history-item-title">
                            {{ session.title || '新对话' }}
                            <i class="el-icon-edit edit-btn" @click.stop="startEditSession(session)"></i>
                        </div>
                        <div class="history-item-preview">{{ formatTime(session.updated_at) }}</div>
                    </div>
                    
                    <div class="history-item-edit" v-else @click.stop>
                        <el-input size="mini" v-model="editTitle" 
                                  ref="editInput"
                                  @blur="saveSessionTitle(session)"
                                  @keyup.enter.native="saveSessionTitle(session)"></el-input>
                    </div>

                    <i class="el-icon-delete delete-btn" v-if="editingSessionId !== session.id" @click.stop="deleteSession(session.id)"></i>
                </div>
                <div v-if="sessionList.length === 0" class="history-empty">
                    暂无历史对话
                </div>
            </div>
        </div>
        <div id="chat-main">
            <div id="chat-header">
                <div>
                    <div class="chat-header-title">{{ currentSessionTitle }}</div>
                    <div class="chat-header-subtitle">支持 Markdown 渲染和上下文记忆</div>
                </div>
                <div style="margin-left: auto;">
                    <el-button size="mini" @click="goHome">返回主页</el-button>
                </div>
            </div>
            <div id="chat-container">
                <div id="messages">
                    <div v-for="(msg,index) in messages" :key="index"
                         class="message" :class="msg.role">
                        <div v-html="msg.html || renderMarkDown(msg.content)">
                        </div>
                    </div>
                </div>
                <div id="input-area">
                    <el-row>
                        <el-col :span="22">
                            <el-input v-model="input" type="textarea" :rows="2"
                                      placeholder="请输入信息，按 Enter 发送..."
                                      @keydown.enter.native.prevent="sendMessage">
                            </el-input>
                        </el-col>
                        <el-col :span="2">
                            <el-button type="primary" @click="sendMessage" :loading="sending">发送</el-button>
                        </el-col>
                    </el-row>
                </div>
            </div>
        </div>
    </div>
</div>
{% endverbatim %}
</body>
<script>
    new Vue({
        el: '#chatApp',
        data() {
            return {
                input: '',
                messages: [],
                sessionList: [],
                currentSessionId: null,
                sending: false,
                editingSessionId: null,
                editTitle: ''
            }
        },
        computed: {
            currentSessionTitle() {
                if (!this.currentSessionId) return "猫娘AI 聊天助手";
                const sess = this.sessionList.find(s => s.id === this.currentSessionId);
                return sess ? sess.title : "猫娘AI 聊天助手";
            }
        },
        methods: {
            formatTime(timeStr) {
                if (!timeStr) return '';
                return new Date(timeStr).toLocaleString();
            },
            scrollToBottom() {
                this.$nextTick(() => {
                    const container = document.getElementById('messages');
                    if(container) container.scrollTop = container.scrollHeight;
                });
            },
            renderMarkDown(text) {
                // 如果text是空或者undefined，返回空字符串
                if (!text) return '';
                // 使用 marked 解析 Markdown
                let rawHtml = marked.parse(text);
                
                // 移除所有 <del> 和 <s> 标签，以及带有 text-decoration: line-through 的样式
                // 这里我们先用简单的正则替换掉删除线标签，再交给 DOMPurify 清洗
                // 1. 替换 Markdown 的删除线语法 ~~text~~
                // text = text.replace(/~~(.*?)~~/g, '$1'); 
                // 注意：marked.parse 已经把 ~~ 转成了 <del>，所以我们要处理的是 HTML
                
                // 使用 DOMPurify 清洗，并配置禁止的标签
                let cleanHtml = DOMPurify.sanitize(rawHtml, {
                    FORBID_TAGS: ['del', 's', 'strike'], // 禁止删除线标签
                    FORBID_ATTR: ['style'] // 简单粗暴禁止内联样式，防止 style="text-decoration: line-through"
                });
                
                return cleanHtml;
            },
            loadSessions() {
                axios.get('/api/sessions/').then(res => {
                    if (res.data.code === 200) {
                        this.sessionList = res.data.data;
                        if (this.sessionList.length > 0) {
                            // If no current session, select the first one (most recent)
                            if (!this.currentSessionId) {
                                this.switchSession(this.sessionList[0].id);
                            }
                        } else {
                            // No sessions, create one
                            this.createNewSession();
                        }
                    }
                });
            },
            createNewSession() {
                axios.get('/api/sessions/create/').then(res => {
                    if (res.data.code === 200) {
                        this.loadSessions(); // Reload list
                        this.switchSession(res.data.data.id);
                        this.messages = [{
                            "role": "assistant",
                            "content": "你好，我是猫娘聊天AI，可以和你聊天喵~"
                        }];
                    }
                });
            },
            switchSession(id) {
                if (this.editingSessionId) return; // Prevent switching while editing
                this.currentSessionId = id;
                this.loadMessages(id);
            },
            loadMessages(sessionId) {
                axios.get('/api/messages/?session_id=' + sessionId).then(res => {
                    if (res.data.code === 200) {
                        this.messages = res.data.data;
                        if (this.messages.length === 0) {
                             this.messages.push({
                                "role": "assistant",
                                "content": "你好，我是 猫娘聊天AI，可以和你聊天喵~"
                            });
                        }
                        this.scrollToBottom();
                    }
                });
            },
            deleteSession(id) {
                if(!confirm('确定删除此对话吗？')) return;
                axios.get('/api/sessions/delete/?session_id=' + id).then(res => {
                    if (res.data.code === 200) {
                        if (this.currentSessionId === id) {
                            this.currentSessionId = null;
                            this.messages = [];
                        }
                        this.loadSessions();
                    }
                });
            },
            startEditSession(session) {
                this.editingSessionId = session.id;
                this.editTitle = session.title;
                this.$nextTick(() => {
                    if(this.$refs.editInput && this.$refs.editInput[0]) {
                        this.$refs.editInput[0].focus();
                    }
                });
            },
            saveSessionTitle(session) {
                if (!this.editingSessionId) return;
                
                const newTitle = this.editTitle.trim();
                if (newTitle && newTitle !== session.title) {
                    axios.post('/api/sessions/update/', {
                        session_id: session.id,
                        title: newTitle
                    }).then(res => {
                        if (res.data.code === 200) {
                            session.title = newTitle;
                        }
                    }).finally(() => {
                        this.editingSessionId = null;
                    });
                } else {
                    this.editingSessionId = null;
                }
            },
            sendMessage() {
                if (!this.input.trim() || this.sending) return;
                
                if (!this.currentSessionId) {
                    this.createNewSession(); 
                    return; 
                }

                this.sending = true;
                const userText = this.input;
                this.messages.push({
                    role: 'user',
                    content: userText
                });
                
                const aiIndex = this.messages.push({
                    role: 'assistant',
                    content: '猫娘正在思考...'
                }) - 1;
                
                let userMsg = {"question": userText};
                this.input = '';
                this.scrollToBottom();

                fetch('/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Chat-Session-ID': this.currentSessionId
                    },
                    body: `messages=${encodeURIComponent(JSON.stringify(userMsg))}`
                }).then(response => {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let aiContent = '';
                    const read = () => {
                        reader.read().then(({done, value}) => {
                            if (done) {
                                this.sending = false;
                                if (!aiContent.trim()) {
                                    this.$set(this.messages, aiIndex, {
                                        role: 'assistant',
                                        content: 'AI 没有返回内容'
                                    });
                                }
                                // Reload sessions to update title/time
                                this.loadSessions();
                                return;
                            }
                            aiContent += decoder.decode(value, {stream: true});
                            this.$set(this.messages, aiIndex, {
                                role: 'assistant',
                                content: aiContent
                            });
                            this.scrollToBottom();
                            read();
                        });
                    };
                    read();
                }).catch(err => {
                    console.error(err);
                    this.sending = false;
                    this.$set(this.messages, aiIndex, {
                        role: 'assistant',
                        content: '请求失败，请稍后重试'
                    });
                });
            },
            goHome() {
                window.location.href = '/';
            }
        },
        mounted() {
            this.loadSessions();
        }
    })
</script>
<style>
    body {
        margin: 0;
        background: linear-gradient(135deg, #FFF0F5 0%, #FFE4E1 100%);
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Comic Sans MS", "Chalkboard SE", "Soft", sans-serif;
    }

    #chatApp {
        width: 1100px;
        max-width: 98%;
        height: 90vh;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 24px;
        box-shadow: 0 20px 40px rgba(255, 182, 193, 0.4);
        overflow: hidden;
        border: 2px solid #FFB6C1;
    }

    #chat-layout {
        display: flex;
        height: 100%;
        min-height: 0;
    }

    #history-panel {
        width: 260px;
        background: linear-gradient(180deg, #FFB6C1 0%, #FFC0CB 100%);
        color: #ffffff;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .history-header {
        padding: 20px 18px 12px 18px;
    }

    .history-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    .history-subtitle {
        font-size: 12px;
        opacity: 0.9;
    }

    .history-list {
        flex: 1;
        overflow-y: auto;
        padding: 0 12px 12px 12px;
    }

    .history-item {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 10px 12px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        border: 1px solid rgba(255,255,255,0.3);
    }

    .history-item:hover {
        background: rgba(255, 255, 255, 0.4);
        transform: translateY(-2px);
    }
    
    .history-item.active {
        background: rgba(255, 255, 255, 0.6);
        border-left: 4px solid #FF69B4;
        color: #FF69B4;
        font-weight: bold;
    }

    .history-item-title {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .history-item-preview {
        font-size: 12px;
        opacity: 0.9;
        word-break: break-all;
    }
    
    .edit-btn, .delete-btn {
        display: none;
        cursor: pointer;
        font-size: 14px;
    }
    
    .edit-btn {
        margin-left: 5px;
        color: #fff;
    }
    
    .delete-btn {
        position: absolute;
        right: 12px;
        top: 32px;
        color: #ff6b6b;
    }

    .history-item:hover .edit-btn,
    .history-item:hover .delete-btn {
        display: inline-block;
    }
    
    .history-item-edit .el-input__inner {
        height: 24px;
        line-height: 24px;
        padding: 0 5px;
        border-radius: 4px;
        border: 1px solid #FFB6C1;
    }

    .history-empty {
        font-size: 12px;
        opacity: 0.9;
        padding: 0 4px;
        text-align: center;
        margin-top: 20px;
        color: #fff;
    }

    #chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #FFF0F5;
        min-height: 0;
        min-width: 0;
        background-image: radial-gradient(#FFB6C1 1px, transparent 1px);
        background-size: 20px 20px;
    }

    #chat-header {
        padding: 16px 20px 10px 20px;
        border-bottom: 2px solid #FFC0CB;
        background: rgba(255,255,255,0.9);
        border-top-right-radius: 24px;
    }

    .chat-header-title {
        font-size: 18px;
        font-weight: 600;
        color: #FF69B4;
        margin-bottom: 4px;
    }

    .chat-header-subtitle {
        font-size: 12px;
        color: #FF99AC;
    }

    #chat-container {
        display: flex;
        flex-direction: column;
        flex: 1;
        height: 100%;
        min-height: 0;
    }

    #messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        border-bottom: 1px solid #FFC0CB;
        min-height: 0;
    }

    .message {
        max-width: 70%;
        margin-bottom: 15px;
        padding: 12px 18px;
        border-radius: 18px;
        word-wrap: break-word;
        overflow-wrap: anywhere;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        font-size: 15px;
        line-height: 1.6;
    }

    /* 根据 class 控制左右和样式 */
    .message.user {
        align-self: flex-end;
        background: #87CEEB; /* 天蓝色 */
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.assistant {
        align-self: flex-start;
        background: #ffffff;
        border: 2px solid #FFC0CB;
        color: #555;
        border-bottom-left-radius: 4px;
        position: relative;
        margin-left: 50px; /* 留出头像空间 */
    }
    
    .message.assistant::before {
        content: '';
        position: absolute;
        left: -55px;
        top: 0;
        width: 45px;
        height: 45px;
        background-image: url('{% static "imgs/1.png" %}');
        background-size: cover;
        border-radius: 50%;
        border: 2px solid #FFB6C1;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    #input-area {
        border-top: 1px solid #FFC0CB;
        padding: 15px;
        background: rgba(255,255,255,0.95);
        border-bottom-right-radius: 24px;
    }
    
    .el-textarea__inner {
        border-radius: 15px !important;
        border: 2px solid #FFC0CB !important;
        padding: 10px 15px !important;
    }
    
    .el-textarea__inner:focus {
        border-color: #FF69B4 !important;
    }
    
    .el-button--primary {
        background-color: #FF69B4 !important;
        border-color: #FF69B4 !important;
        border-radius: 20px !important;
    }
    
    .el-button--primary:hover {
        background-color: #FF1493 !important;
        border-color: #FF1493 !important;
    }
</style>
</html>