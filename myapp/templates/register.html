{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>注册</title>
    <script src="{% static 'js/vue.min.js' %}"></script>
    <script src="{% static 'js/index.js' %}"></script>
    <script src="{% static 'js/axios.min.js' %}"></script>
    <script src="{% static 'js/jquery.js' %}"></script>
    <script src="{% static 'js/faceUtil.js' %}"></script>
    <link href="{% static 'css/index.css' %}" rel="stylesheet">
    <link href="{% static 'css/element-icons.css' %}" rel="stylesheet">
    <style>
        body{
            margin:0;
            min-height:100vh;
            background:linear-gradient(135deg, #FFF0F5 0%, #FFE4E1 100%);
            display:flex;
            align-items:flex-start;
            justify-content:center;
            padding:24px;
            box-sizing:border-box;
            font-family: "Comic Sans MS", "Chalkboard SE", "Soft", sans-serif;
        }
        .auth-card{
            width:100%;
            max-width:980px;
            background:rgba(255, 255, 255, 0.95);
            border-radius:24px;
            box-shadow:0 20px 40px rgba(255, 182, 193, 0.4);
            padding:36px 36px 28px;
            box-sizing:border-box;
            border: 2px solid #FFB6C1;
        }
        .auth-form{
            max-width:560px;
        }
        .auth-form .el-input{
            width:340px;
            max-width:100%;
        }
        .video-wrapper{
            display:flex;
            justify-content:center;
        }
        
        .home-title {
            color: #FF69B4;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .el-button--primary {
            background-color: #FF69B4 !important;
            border-color: #FF69B4 !important;
            border-radius: 12px !important;
        }
        .el-button--primary:hover {
            background-color: #FF1493 !important;
            border-color: #FF1493 !important;
        }
        .el-button.is-plain:hover {
            color: #FF69B4 !important;
            border-color: #FF69B4 !important;
            background-color: #FFF0F5 !important;
        }
        
        .el-input__inner {
            border-radius: 12px !important;
            border: 1px solid #FFC0CB !important;
        }
        .el-input__inner:focus {
            border-color: #FF69B4 !important;
        }
        
        .el-tabs__item.is-active {
            color: #FF69B4 !important;
        }
        .el-tabs__active-bar {
            background-color: #FF69B4 !important;
        }
        .el-tabs__item:hover {
            color: #FF69B4 !important;
        }
        .el-radio__input.is-checked .el-radio__inner {
            border-color: #FF69B4 !important;
            background: #FF69B4 !important;
        }
        .el-radio__input.is-checked+.el-radio__label {
            color: #FF69B4 !important;
        }

        @media (max-width:560px){
            body{padding:16px;}
            .auth-card{padding:24px 16px;}
            .auth-form{max-width:none;}
            .auth-form .el-input{width:100%;}
        }
    </style>
</head>
<body>
<div id="registerApp" class="home-container">
    <div class="home-right auth-card">
        <div class="home-title">注册</div>
        <el-tabs v-model="activeTab">
            <el-tab-pane label="账号注册" name="account">
                <el-form class="auth-form" :model="registerForm" label-width="80px">
                    <el-form-item label="姓名">
                        <el-input v-model="registerForm.name" placeholder="请输入姓名"></el-input>
                    </el-form-item>
                    <el-form-item label="性别">
                        <el-radio-group v-model="registerForm.gender">
                            <el-radio label="男">男</el-radio>
                            <el-radio label="女">女</el-radio>
                        </el-radio-group>
                    </el-form-item>
                    <el-form-item label="年龄">
                        <el-input v-model="registerForm.age" placeholder="1-150" maxlength="3"></el-input>
                    </el-form-item>
                    <el-form-item label="手机号">
                        <el-input v-model="registerForm.phone" maxlength="11" placeholder="请输入11位手机号"></el-input>
                    </el-form-item>
                    <el-form-item label="密码">
                        <el-input v-model="registerForm.password" type="password" placeholder="6-20位，包含数字和字母"></el-input>
                    </el-form-item>
                    <el-form-item label="确认密码">
                        <el-input v-model="registerForm.password2" type="password" placeholder="请再次输入密码"></el-input>
                    </el-form-item>
                    <div class="error-text">{{ registerError }}</div>
                    <div class="btn-row">
                        <el-button type="primary" :loading="registerLoading" @click="submitRegister">注册</el-button>
                        <el-button plain @click="goHome">返回首页</el-button>
                    </div>
                </el-form>
            </el-tab-pane>
            <el-tab-pane label="人脸注册" name="face">
                <div class="section-title">填写信息并采集人脸</div>
                <div class="video-wrapper" style="margin-top:8px;">
                    <div id="video" v-if="activeTab === 'face'"></div>
                </div>
                <el-form class="auth-form" :model="faceForm" label-width="80px" style="margin-top:8px;">
                    <el-form-item label="姓名">
                        <el-input v-model="faceForm.name" placeholder="请输入姓名"></el-input>
                    </el-form-item>
                    <el-form-item label="性别">
                        <el-radio-group v-model="faceForm.gender">
                            <el-radio label="男">男</el-radio>
                            <el-radio label="女">女</el-radio>
                        </el-radio-group>
                    </el-form-item>
                    <el-form-item label="年龄">
                        <el-input v-model="faceForm.age" maxlength="3" placeholder="1-150"></el-input>
                    </el-form-item>
                    <el-form-item label="手机号">
                        <el-input v-model="faceForm.phone" maxlength="11" placeholder="请输入11位手机号"></el-input>
                    </el-form-item>
                    <el-form-item label="密码">
                        <el-input v-model="faceForm.password" type="password" placeholder="6-20位，包含数字和字母"></el-input>
                    </el-form-item>
                    <el-form-item label="确认密码">
                        <el-input v-model="faceForm.password2" type="password" placeholder="请再次输入密码"></el-input>
                    </el-form-item>
                    <div class="error-text">{{ faceError }}</div>
                    <div class="btn-row">
                        <el-button type="primary" :loading="faceLoading" @click="facecollect">采集并注册</el-button>
                        <el-button plain @click="goHome">返回首页</el-button>
                    </div>
                </el-form>
            </el-tab-pane>
            <el-tab-pane label="人脸录入" name="enroll">
                <div class="section-title">已有账号通过手机号与密码单独录入人脸</div>
                <div class="video-wrapper" style="margin-top:8px;">
                    <div id="videoEnroll" v-if="activeTab === 'enroll'"></div>
                </div>
                <el-form class="auth-form" :model="enrollForm" label-width="80px" style="margin-top:8px;">
                    <el-form-item label="手机号">
                        <el-input v-model="enrollForm.phone" maxlength="11" placeholder="请输入11位手机号"></el-input>
                    </el-form-item>
                    <el-form-item label="密码">
                        <el-input v-model="enrollForm.password" type="password" placeholder="请输入密码"></el-input>
                    </el-form-item>
                    <div class="error-text">{{ enrollError }}</div>
                    <div class="btn-row">
                        <el-button type="primary" :loading="enrollLoading" @click="submitEnroll">录入人脸</el-button>
                        <el-button plain @click="goHome">返回首页</el-button>
                    </div>
                </el-form>
            </el-tab-pane>
        </el-tabs>
    </div>
</div>
<script>
    new Vue({
        el: '#registerApp',
        data: function () {
            return {
                activeTab: 'account',
                registerForm: { name: '', gender: '男', age: '', phone: '', password: '', password2: '' },
                registerLoading: false,
                registerError: '',
                faceForm: { name: '', gender: '男', age: '', phone: '', password: '', password2: '' },
                faceLoading: false,
                faceError: '',
                enrollForm: { phone: '', password: '' },
                enrollLoading: false,
                enrollError: ''
            }
        },
        mounted: function () {
            this.ensureCam()
        },
        watch: {
            activeTab: function (v) {
                // 切换tab时先关闭旧的
                try { faceUtile.closeVideo() } catch(e){}
                this.ensureCam()
            }
        },
        methods: {
            validatePhone: function (phone) { return /^\d{11}$/.test(phone) },
            validateAge: function (age) { var n=parseInt(age); if(isNaN(n))return false; return n>=1&&n<=150 },
            validatePassword: function (pwd) {
                if (!pwd) return false
                if (pwd.length < 6 || pwd.length > 20) return false
                if (!/[A-Za-z]/.test(pwd)) return false
                if (!/[0-9]/.test(pwd)) return false
                return true
            },
            submitRegister: function () {
                var f = this.registerForm, that=this
                this.registerError = ''
                if (!f.name) { this.registerError='姓名不能为空'; alert(this.registerError); return }
                if (!this.validateAge(f.age)) { this.registerError='年龄必须是1-150岁的整数'; alert(this.registerError); return }
                if (!this.validatePhone(f.phone)) { this.registerError='手机号必须为11位数字'; alert(this.registerError); return }
                if (!this.validatePassword(f.password)) { this.registerError='密码格式不正确'; alert(this.registerError); return }
                if (f.password !== f.password2) { this.registerError='两次输入的密码不一致'; alert(this.registerError); return }
                this.registerLoading = true
                axios.post('/api/register/', { name:f.name, gender:f.gender, age:f.age, phone:f.phone, pwd:f.password, pwd2:f.password2 })
                    .then(function (res) {
                        var data = res.data
                        if (data.code === 200) {
                            alert('注册成功')
                            window.location.href = '/'
                        } else {
                            that.registerError = data.msg || '注册失败'; alert(that.registerError)
                        }
                    }).catch(function () {
                        that.registerError = '请求失败，请稍后重试'; alert(that.registerError)
                    }).then(function () { that.registerLoading = false })
            },
            ensureCam: function () {
                var that=this
                this.$nextTick(function(){
                    try {
                        faceUtile.width = 640
                        faceUtile.height = 480
                        if (that.activeTab === 'face') {
                            faceUtile.openVideo("video")
                        } else if (that.activeTab === 'enroll') {
                            faceUtile.openVideo("videoEnroll")
                        }
                    } catch (e) {}
                })
            },
            facecollect: function () {
                var f=this.faceForm
                this.faceError=''
                if (!f.name) { this.faceError='姓名不能为空'; alert(this.faceError); return }
                if (!this.validateAge(f.age)) { this.faceError='年龄必须是1-150岁的整数'; alert(this.faceError); return }
                if (!this.validatePhone(f.phone)) { this.faceError='手机号必须为11位数字'; alert(this.faceError); return }
                if (!this.validatePassword(f.password)) { this.faceError='密码格式不正确'; alert(this.faceError); return }
                if (f.password !== f.password2) { this.faceError='两次输入的密码不一致'; alert(this.faceError); return }
                var code = faceUtile.getDecode()
                if (!code) { this.faceError='未获取到人脸图片，请检查摄像头'; alert(this.faceError); return }
                var that=this
                this.faceLoading=true
                axios.post('/face_collect/', { name:f.name, gender:f.gender, age:f.age, phone:f.phone, pwd:f.password, pwd2:f.password2, image: code })
                    .then(function(res){
                        var data=res.data
                        if(data.code===200){
                            alert('注册成功')
                            window.location.href = '/'
                        }else{
                            that.faceError = data.msg || '注册失败'; alert(that.faceError)
                        }
                    }).catch(function(){ that.faceError='请求失败，请稍后重试'; alert(that.faceError) })
                      .then(function(){ that.faceLoading=false })
            },
            submitEnroll: function () {
                var f=this.enrollForm
                this.enrollError=''
                if (!this.validatePhone(f.phone)) { this.enrollError='手机号必须为11位数字'; alert(this.enrollError); return }
                if (!f.password) { this.enrollError='密码不能为空'; alert(this.enrollError); return }
                var code = faceUtile.getDecode()
                if (!code) { this.enrollError='未获取到人脸图片，请检查摄像头'; alert(this.enrollError); return }
                var that=this
                this.enrollLoading=true
                axios.post('/face_enroll/', { phone:f.phone, password:f.password, image: code })
                    .then(function(res){
                        var data=res.data
                        if(data.code===200){
                            alert('录入成功')
                            window.location.href = '/'
                        }else{
                            that.enrollError = data.msg || '录入失败'; alert(that.enrollError)
                        }
                    }).catch(function(){ that.enrollError='请求失败，请稍后重试'; alert(that.enrollError) })
                      .then(function(){ that.enrollLoading=false })
            },
            goHome: function () { window.location.href='/' }
        }
    })
</script>
</body>
</html>
