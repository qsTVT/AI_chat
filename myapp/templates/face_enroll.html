{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>人脸录入</title>
    <script src="{% static 'js/vue.min.js' %}"></script>
    <script src="{% static 'js/index.js' %}"></script>
    <script src="{% static 'js/axios.min.js' %}"></script>
    <script src="{% static 'js/jquery.js' %}"></script>
    <script src="{% static 'js/faceUtil.js' %}"></script>
    <link href="{% static 'css/index.css' %}" rel="stylesheet">
    <link href="{% static 'css/element-icons.css' %}" rel="stylesheet">
</head>
<body>
<div id="enrollApp" class="home-container">
    <div class="home-right" style="width:100%;padding:40px 36px;">
        <div class="home-title">人脸录入</div>
        <div class="home-subtitle">账号注册后可在此单独录入人脸信息；需验证手机号与密码。</div>
        <div class="video-wrapper" style="margin-top:8px;">
            <div id="video"></div>
        </div>
        <el-form :model="form" label-width="80px" style="margin-top:8px;">
            <el-form-item label="手机号">
                <el-input v-model="form.phone" maxlength="11" placeholder="请输入11位手机号"></el-input>
            </el-form-item>
            <el-form-item label="密码">
                <el-input v-model="form.password" type="password" placeholder="请输入密码"></el-input>
            </el-form-item>
            <div class="error-text">{{ errorText }}</div>
            <div class="btn-row">
                <el-button type="primary" :loading="loading" @click="submit">录入人脸</el-button>
                <el-button plain @click="goHome">返回首页</el-button>
            </div>
        </el-form>
    </div>
</div>
<script>
    new Vue({
        el: '#enrollApp',
        data: function () {
            return {
                form: { phone: '', password: '' },
                loading: false,
                errorText: ''
            }
        },
        mounted: function () {
            this.openCam()
        },
        methods: {
            openCam: function () {
                this.$nextTick(function(){
                    try {
                        faceUtile.width = 640
                        faceUtile.height = 480
                        faceUtile.openVideo("video")
                    } catch (e) {}
                })
            },
            submit: function () {
                var phone = this.form.phone
                var pwd = this.form.password
                this.errorText = ''
                if (!/^\d{11}$/.test(phone)) { this.errorText = '手机号必须为11位数字'; alert(this.errorText); return }
                if (!pwd) { this.errorText = '密码不能为空'; alert(this.errorText); return }
                var code = faceUtile.getDecode()
                if (!code) { this.errorText = '未获取到人脸图片，请检查摄像头'; alert(this.errorText); return }
                var that = this
                this.loading = true
                axios.post('/face_enroll/', { phone: phone, password: pwd, image: code })
                    .then(function (res) {
                        var data = res.data
                        if (data.code === 200) {
                            alert('录入成功')
                            window.location.href = '/'
                        } else {
                            that.errorText = data.msg || '录入失败'; alert(that.errorText)
                        }
                    }).catch(function () {
                        that.errorText = '请求失败，请稍后重试'; alert(that.errorText)
                    }).then(function () { that.loading = false })
            },
            goHome: function () { window.location.href = '/' }
        }
    })
</script>
</body>
</html>
