{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>登录</title>
    <script src="{% static 'js/vue.min.js' %}"></script>
    <script src="{% static 'js/index.js' %}"></script>
    <script src="{% static 'js/axios.min.js' %}"></script>
    <script src="{% static 'js/jquery.js' %}"></script>
    <script src="{% static 'js/faceUtil.js' %}"></script>
    <link href="{% static 'css/index.css' %}" rel="stylesheet">
    <link href="{% static 'css/element-icons.css' %}" rel="stylesheet">
    <style>
        body{
            margin:0;
            min-height:100vh;
            background:linear-gradient(135deg, #FFF0F5 0%, #FFE4E1 100%);
            display:flex;
            align-items:flex-start;
            justify-content:center;
            padding:24px;
            box-sizing:border-box;
            font-family: "Comic Sans MS", "Chalkboard SE", "Soft", sans-serif;
        }
        .auth-card{
            width:100%;
            max-width:920px;
            background:rgba(255, 255, 255, 0.95);
            border-radius:24px;
            box-shadow:0 20px 40px rgba(255, 182, 193, 0.4);
            padding:36px 36px 28px;
            box-sizing:border-box;
            border: 2px solid #FFB6C1;
        }
        .auth-form{
            max-width:520px;
        }
        .auth-form .el-input{
            width:340px;
            max-width:100%;
        }
        .video-wrapper{
            display:flex;
            justify-content:center;
        }
        .home-title {
            color: #FF69B4;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .el-button--primary {
            background-color: #FF69B4 !important;
            border-color: #FF69B4 !important;
            border-radius: 12px !important;
        }
        .el-button--primary:hover {
            background-color: #FF1493 !important;
            border-color: #FF1493 !important;
        }
        .el-button.is-plain:hover {
            color: #FF69B4 !important;
            border-color: #FF69B4 !important;
            background-color: #FFF0F5 !important;
        }
        
        .el-input__inner {
            border-radius: 12px !important;
            border: 1px solid #FFC0CB !important;
        }
        .el-input__inner:focus {
            border-color: #FF69B4 !important;
        }
        
        .el-tabs__item.is-active {
            color: #FF69B4 !important;
        }
        .el-tabs__active-bar {
            background-color: #FF69B4 !important;
        }
        .el-tabs__item:hover {
            color: #FF69B4 !important;
        }

        @media (max-width:560px){
            body{padding:16px;}
            .auth-card{padding:24px 16px;}
            .auth-form{max-width:none;}
            .auth-form .el-input{width:100%;}
        }
    </style>
</head>
<body>
<div id="loginApp" class="home-container">
    <div class="home-right auth-card">
        <div class="home-title">登录</div>
        <el-tabs v-model="activeTab">
            <el-tab-pane label="账号登录" name="account">
                <el-form class="auth-form" :model="loginForm" label-width="80px">
                    <el-form-item label="手机号">
                        <el-input v-model="loginForm.phone" maxlength="11" placeholder="请输入11位手机号"></el-input>
                    </el-form-item>
                    <el-form-item label="密码">
                        <el-input v-model="loginForm.password" :type="passwordVisible ? 'text' : 'password'" placeholder="6-20位，包含数字和字母">
                            <span slot="suffix" @click="togglePassword" style="cursor:pointer;display:inline-flex;align-items:center;height:100%;padding-right:2px;">
                                <svg v-if="passwordVisible" width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M1.5 12s3.9-7.5 10.5-7.5S22.5 12 22.5 12s-3.9 7.5-10.5 7.5S1.5 12 1.5 12Z" stroke="#606266" stroke-width="1.6"/>
                                    <path d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4Z" stroke="#606266" stroke-width="1.6"/>
                                </svg>
                                <svg v-else width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M3 4.5 21 19.5" stroke="#606266" stroke-width="1.6" stroke-linecap="round"/>
                                    <path d="M10.3 9.1A3.2 3.2 0 0 0 12 15.2c.6 0 1.2-.2 1.7-.5" stroke="#606266" stroke-width="1.6" stroke-linecap="round"/>
                                    <path d="M6.2 7.1C3.4 9.1 1.5 12 1.5 12s3.9 7.5 10.5 7.5c1.6 0 3-.3 4.3-.8" stroke="#606266" stroke-width="1.6" stroke-linecap="round"/>
                                    <path d="M19.2 16.9c2.1-1.9 3.3-4.9 3.3-4.9s-3.9-7.5-10.5-7.5c-.9 0-1.8.1-2.7.3" stroke="#606266" stroke-width="1.6" stroke-linecap="round"/>
                                </svg>
                            </span>
                        </el-input>
                    </el-form-item>
                    <div class="error-text">{{ loginError }}</div>
                    <div class="btn-row">
                        <el-button type="primary" :loading="loginLoading" @click="submitLogin">登录</el-button>
                        <el-button plain @click="goHome">返回首页</el-button>
                    </div>
                </el-form>
            </el-tab-pane>
            <el-tab-pane label="人脸登录" name="face">
                <div class="section-title">使用摄像头进行人脸识别</div>
                <div class="video-wrapper" style="margin-top:8px;">
                    <div id="video"></div>
                </div>
                <div class="btn-row">
                    <el-button type="primary" :loading="faceLoading" @click="facedetect">开始检测</el-button>
                    <el-button plain @click="goHome">返回首页</el-button>
                </div>
                <div class="error-text">{{ faceError }}</div>
            </el-tab-pane>
        </el-tabs>
    </div>
</div>
<script>
    new Vue({
        el: '#loginApp',
        data: function () {
            return {
                activeTab: 'account',
                loginForm: { phone: '', password: '' },
                passwordVisible: false,
                loginLoading: false,
                loginError: '',
                faceLoading: false,
                faceError: ''
            }
        },
        mounted: function () {
            if (this.activeTab === 'face') {
                this.openCam()
            }
        },
        watch: {
            activeTab: function (v) {
                if (v === 'face') {
                    this.openCam()
                }
            }
        },
        methods: {
            validatePhone: function (phone) { return /^\d{11}$/.test(phone) },
            togglePassword: function () { this.passwordVisible = !this.passwordVisible },
            validatePassword: function (pwd) {
                if (!pwd) return false
                if (pwd.length < 6 || pwd.length > 20) return false
                if (!/[A-Za-z]/.test(pwd)) return false
                if (!/[0-9]/.test(pwd)) return false
                return true
            },
            submitLogin: function () {
                var phone = this.loginForm.phone
                var pwd = this.loginForm.password
                this.loginError = ''
                if (!this.validatePhone(phone)) { this.loginError = '手机号必须为11位数字'; alert(this.loginError); return }
                if (!this.validatePassword(pwd)) { this.loginError = '密码格式不正确'; alert(this.loginError); return }
                var that = this
                this.loginLoading = true
                axios.post('/api/login/', { phone: phone, password: pwd })
                    .then(function (res) {
                        var data = res.data
                        if (data.code === 200) {
                            window.location.href = '/'
                        } else {
                            that.loginError = data.msg || '登录失败'; alert(that.loginError)
                        }
                    }).catch(function () {
                        that.loginError = '请求失败，请稍后重试'; alert(that.loginError)
                    }).then(function () { that.loginLoading = false })
            },
            openCam: function () {
                var that=this
                this.$nextTick(function(){
                    try {
                        faceUtile.width = 640
                        faceUtile.height = 480
                        faceUtile.openVideo("video")
                    } catch (e) {}
                })
            },
            facedetect: function () {
                var code = faceUtile.getDecode()
                if (!code) {
                    this.faceError = "未获取到人脸图片，请检查摄像头"
                    alert(this.faceError)
                    return
                }
                var that = this
                this.faceError = ''
                this.faceLoading = true
                axios.post("/face_detect/", { image: code }).then(function (res) {
                    var data = res.data
                    if (data.code === 200) {
                        var name = data && data.data && data.data.name ? data.data.name : ''
                        alert('欢迎：' + name)
                        window.location.href = '/'
                    } else {
                        that.faceError = data.msg || "人脸匹配失败"
                        alert(that.faceError)
                    }
                }).catch(function () {
                    that.faceError = "请求失败，请稍后重试"
                    alert(that.faceError)
                }).then(function () {
                    that.faceLoading = false
                })
            },
            goHome: function () { window.location.href = '/' }
        }
    })
</script>
</body>
</html>
